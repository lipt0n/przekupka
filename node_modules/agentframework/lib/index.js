/* Copyright 2016 Ling Zhang

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. */

function t(t,e,r,n){return t.beforeDecorate(e,r,n)}function e(t){return Reflect.has(t,"interceptor")}function r(t){return Reflect.has(t,"initializer")}Object.defineProperty(exports,"__esModule",{value:!0});class Member{constructor(t){this._attributes=[],this._metadata=new Map,this._hasInterceptor=!1,this._hasInitializer=!1,this.parent=t}addAttribute(t){this._attributes.push(t),e(t)&&(this._hasInterceptor=!0),r(t)&&(this._hasInitializer=!0)}getAttributes(t){return t?this._attributes.filter(e=>e instanceof t):this._attributes.slice(0)}hasAttribute(t){return t?this._attributes.some(e=>e instanceof t):!!this._attributes.length}getInterceptors(){return this._attributes.filter(e)}getInitializers(){return this._attributes.filter(r)}hasInterceptor(){return this._hasInterceptor}hasInitializer(){return this._hasInitializer}hasMetadata(){return this._metadata.size>0}getMetadata(t){return this._metadata.get(t)}addMetadata(t,e){this._metadata.set(t,e)}}class Parameter extends Member{constructor(t,e){super(t),this.index=e}get type(){return this.getMetadata("design:type")}}class Method extends Member{constructor(t,e){super(t),this.maxParameters=e,this._parameters=new Array}parameter(t){if("number"==typeof(e=this.maxParameters)&&!isNaN(e)&&t>this.maxParameters)throw new TypeError(`Parameter index out of boundary: ${t}. Max is ${this.maxParameters}`);var e;let r=this._parameters[t];return r||(r=new Parameter(this,t),this._parameters[t]=r),r}parameters(){return this._cachedParameters||(this._cachedParameters=this._parameters.filter(t=>t.hasInitializer()||t.hasInterceptor())),this._cachedParameters}hasParameters(){return this.parameters().length>0}get paramtypes(){return this.getMetadata("design:paramtypes")}get returntype(){return this.getMetadata("design:returntype")}}var n;(n=exports.AgentFeatures||(exports.AgentFeatures={}))[n.None=0]="None",n[n.Metadata=1]="Metadata",n[n.Initializer=2]="Initializer",n[n.Interceptor=4]="Interceptor",n[n.Altered=6]="Altered";class Property extends Member{constructor(t,e,r){super(t),this._key=e,this._descriptor=r}get value(){let t=0;const e=this._descriptor;e&&e.value&&"function"==typeof e.value&&(t=e.value.length);const r=new Method(this,t);return Reflect.defineProperty(this,"value",{value:r}),r}get setter(){const t=new Method(this,1);return Reflect.defineProperty(this,"setter",{value:t}),t}get getter(){const t=new Method(this,0);return Reflect.defineProperty(this,"getter",{value:t}),t}hasInitializers(){return null==this._hasInitializers&&(this._hasInitializers=this.hasInitializer()||this.setter.hasInitializer()||this.value.hasInitializer()),this._hasInitializers}hasInterceptors(){return null==this._hasInterceptors&&(this._hasInterceptors=this.hasInterceptor()||this.getter.hasInterceptor()||this.value.hasInterceptor()||this.value.hasParameters()),this._hasInterceptors}hasFeatures(t){if(this._hasInitializers&&this._hasInterceptors)return t>1;switch(t){case exports.AgentFeatures.Metadata:return this.hasMetadata();case exports.AgentFeatures.Initializer:return this.hasInitializers();case exports.AgentFeatures.Interceptor:return this.hasInterceptors();case exports.AgentFeatures.Altered:return this.hasInitializers()||this.hasInterceptors();default:return!1}}get type(){return this.getMetadata("design:type")}get paramtypes(){return this.getMetadata("design:paramtypes")}get returntype(){return this.getMetadata("design:returntype")}get targetKey(){return this._key}get descriptor(){return this._descriptor}addMetadata(t,e){if(super.addMetadata(t,e),this._descriptor){if(this._descriptor.value)if("design:paramtypes"===t&&e&&e.length){this.value.addMetadata("design:paramtypes",e);const t=e;for(let e=t.length-1;e>=0;e--)this.value.parameter(e).addMetadata("design:type",t[e])}else"design:returntype"===t&&this.value.addMetadata("design:returntype",e);if(this._descriptor.get&&"design:type"===t&&this.getter.addMetadata("design:returntype",e),this._descriptor.set&&"design:paramtypes"===t&&e&&e.length){this.setter.addMetadata("design:paramtypes",e);const t=e;for(let e=t.length-1;e>=0;e--)this.setter.parameter(e).addMetadata("design:type",t[e])}}else this.value.addMetadata(t,e)}}class PropertyFilters{static FilterAttribute(t,e){return t.hasAttribute(e)}static FilterFeatures(t,e){if(null==e)throw new Error("Missing AgentFeatures to filter");return t.hasFeatures(e)}}const i=new Function("k","return k=Symbol.for(k),this[k]||(this[k]=new WeakMap())"),s=i("AgentFramework.Agents"),a=i("AgentFramework.Types");function o(t){return s.has(t)}class Type extends Method{constructor(t){super(null,t.constructor.length),this._prototype=t,this._properties=new Map}static of(t){let e=a.get(t);return e||(e=new Type(t),a.set(t,e)),e}get class(){return this._prototype.constructor}get prototype(){return this._prototype}types(){if(!this._prototypes){this._prototypes=[];let t=this._prototype;for(;t;)this._prototypes.unshift(Type.of(t)),t=Object.getPrototypeOf(t)}return this._prototypes}addMetadata(t,e){if(super.addMetadata(t,e),"design:paramtypes"===t&&e&&e.length){const t=e;for(let e=t.length-1;e>=0;e--)this.parameter(e).addMetadata("design:type",t[e])}}property(t,e){return this._properties.has(t)||(e=e||Object.getOwnPropertyDescriptor(this._prototype,t),this._properties.set(t,new Property(this,t,e))),this._properties.get(t)}properties(){return this._properties.values()}hasFeatures(t){for(const e of this.types())for(const r of e._properties.values())if(PropertyFilters.FilterFeatures(r,t))return!0;return!1}findOwnProperties(t,e){const r=new Map;for(const[n,i]of this._properties.entries())t(i,e)&&r.set(n,i);return r}findProperties(t,e){const r=[];for(const n of this.types()){const i=n.findOwnProperties(t,e);r.push([n,i])}return r}}function c(t){if(new.target)throw new SyntaxError("Not allow calling new Reflector");let e,r;if("function"!=typeof t){if("object"==typeof t){const e=Object.getOwnPropertyDescriptor(t,"constructor");if(e&&"function"==typeof e.value)return Type.of(t);throw new Error("AgentFramework 1.x do not support access metadata on instance")}throw new TypeError("Reflection target type is not supported")}return e=t,r=s.has(e)?s.get(e).prototype:e.prototype,Type.of(r)}var p;(p=exports.Target||(exports.Target={}))[p.Constructor=1]="Constructor",p[p.ConstructorParameter=2]="ConstructorParameter",p[p.Field=4]="Field",p[p.Method=8]="Method",p[p.MethodParameter=16]="MethodParameter",p[p.Getter=32]="Getter",p[p.Setter=64]="Setter";class InitializerInvocation{constructor(t,e){this._invocation=t,this._initializer=e}get design(){return this._invocation.design}get target(){return this._invocation.target}get agent(){return this._invocation.agent}invoke(t){return this._initializer.initialize(this._invocation,t)}}class InterceptorInvocation{constructor(t,e){this._invocation=t,this._interceptor=e}get design(){return this._invocation.design}get target(){return this._invocation.target}get agent(){return this._invocation.agent}invoke(t){return this._interceptor.intercept(this._invocation,t)}}class AgentInvocation{constructor(t){this._target=t}get design(){return c(this._target)}get target(){return this._target}get agent(){}invoke([t,e,r]){if(t===this.target)return t;const n=[t,"Reflect",`return ${e}`];return Reflect.construct(Function,n)(this.target,r)}}function u(t,e){if(s.has(t))return t;let r=new AgentInvocation(t);const n=e.initializer;n&&"function"==typeof n.initialize&&(r=new InitializerInvocation(r,n));const i=e.interceptor;i&&"function"==typeof i.intercept&&(r=new InterceptorInvocation(r,i));const a=r.invoke(arguments);return a!==t&&s.set(a,t),a}function l(e,r){return n=>{if(r&&r.length){const e=c(n);for(const i of r)t(i,n)&&e.addAttribute(i)}return t(e,n)?u(n,e):n}}const h=new WeakMap;function g(t,e){let r=a.get(t);return void 0===r&&(r=Reflect.construct(t,e||[]),a.set(t,r)),r}class Compiler{constructor(t){this.target=t,this.generated=this.target}defineFields(t,e){if(t&&t.size)for(const[r,[n,i]]of t)Object.defineProperty(this.generated.prototype,r,{get:function(){Reflect.set(n,"agent",this);const t=i.invoke(e());return Reflect.defineProperty(this,r,{value:t,configurable:!0,enumerable:!0,writable:!0}),t},set:function(t){Reflect.defineProperty(this,r,{value:t,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0})}defineProperties(t){if(t&&t.size)for(const[e,r]of t)Object.defineProperty(this.generated.prototype,e,r)}compile(){return this.generated}}class FieldInvocation{constructor(t,e,r,n){this._target=t,this._design=r,this._newAgent=n}get design(){return this._design}get target(){return this._target}get agent(){return this._newAgent}set agent(t){this._newAgent=t}invoke(t){}}class ParameterInvocation{constructor(t,e,r){this._target=t,this._design=e,this._newAgent=r}get design(){return this._design}get target(){return this._target}get agent(){return this._newAgent}set agent(t){this._newAgent=t}invoke(t){return t[0]}}class InitializerFactory{static createFieldInitializer(t,e,r){return new FieldInvocation(t,e,r)}static createParameterInitializer(t,e){return new ParameterInvocation(t,e)}static chainInitializerAttributes(t,e){for(const r of e){const e=r.initializer;e&&"function"==typeof e.initialize&&(t=new InitializerInvocation(t,e))}return t}}class InterceptorChainFactory{static chainInterceptorAttributes(t,e){for(const r of e){const e=r.interceptor;e&&"function"==typeof e.intercept&&(t=new InterceptorInvocation(t,e))}return t}}class DirectMethodInvocation{constructor(t,e,r,n){this._target=t,this.method=e,this._design=r,this._newAgent=n}get design(){return this._design}get target(){return this._target}get agent(){return this._newAgent}set agent(t){this._newAgent=t}invoke(t){return Reflect.apply(this.method,this._newAgent,t)}}class InterceptedMethodInvocation{constructor(t,e,r,n,i){this._target=t,this.method=e,this._design=r,this.params=n,this._newAgent=i}get design(){return this._design}get target(){return this._target}get agent(){return this._newAgent}set agent(t){this._newAgent=t;for(const[,[e]]of this.params.entries())Reflect.set(e,"agent",t)}invoke(t){const e=Array.prototype.slice.call(t,0);for(const[r,[,n]]of this.params.entries())e[r]=n.invoke([t[r],r,t]);return Reflect.apply(this.method,this._newAgent,e)}}class InterceptorFunctionFactory{static createFunction(t,e,r,n,i){let s,a;i&&i.size?(s=new InterceptedMethodInvocation(e,r,n,i),a=new Function("c","o",`return function ${r.name}$(){return o.agent=this,c.invoke(arguments)}`)):(s=new DirectMethodInvocation(e,r,n),a=new Function("c","o","return function(){return o.agent=this,c.invoke(arguments)}"));const o=InterceptorChainFactory.chainInterceptorAttributes(s,t);return o instanceof DirectMethodInvocation?r:a(o,s)}}class AgentCompiler{compile(t,e){const r=new Set;let n,i,s;if(n=this.makePropertyInitializers(t,r),i=this.makePropertyInterceptors(t,r),n||i){const r=new Compiler(t);r.defineFields(n,e),r.defineProperties(i),s=r.compile()}else s=t;return s}compileParameters(t,e){const r=e.parameters(),n=new Map;for(const e of r){let r=e.getInitializers();const i=InitializerFactory.createParameterInitializer(t,e),s=InitializerFactory.chainInitializerAttributes(i,r);let a=e.getInterceptors();const o=InterceptorChainFactory.chainInterceptorAttributes(s,a);n.set(e.index,[i,o])}return n}makePropertyInterceptors(t,e){const r=c(t).findProperties(PropertyFilters.FilterFeatures,exports.AgentFeatures.Interceptor);let n;for(const[i,s]of r)if(!o(i.class))for(const[,r]of s){const i=r.targetKey,s=r.descriptor;if(!s){if(r.hasInitializer()||r.value.hasInitializer())continue;throw new Error(`Class: ${t.prototype.constructor.name}; Property: ${r.targetKey.toString()}; `+"Interceptor not work with field property without Initializer")}const a=Object.create(s),o=s.value,c=s.get,p=s.set;let u=r.getInterceptors();if("function"==typeof c&&(u=r.getter.getInterceptors().concat(u),a.get=InterceptorFunctionFactory.createFunction(u,t,c,r.getter)),"function"==typeof p&&(u=r.setter.getInterceptors().concat(u),a.set=InterceptorFunctionFactory.createFunction(u,t,p,r.setter)),"function"==typeof o){let e;u=r.value.getInterceptors().concat(u),r.value.hasParameters()&&(e=this.compileParameters(o,r.value)),a.value=InterceptorFunctionFactory.createFunction(u,t,o,r.value,e)}if(e.has(i))throw new Error(`Class: ${t.prototype.constructor.name}; Property: ${r.targetKey.toString()}; `+"Duplicate interceptor");e.add(i),n||(n=new Map),n.set(i,a)}return n}makePropertyInitializers(t,e){const r=c(t).findProperties(PropertyFilters.FilterFeatures,exports.AgentFeatures.Initializer);let n;for(const[i,s]of r)if(!o(i.class))for(const[,r]of s){const i=r.targetKey;if(r.descriptor)throw new Error(`Class: ${t.prototype.constructor.name}; Property: ${r.targetKey.toString()}; `+"Initializer not work with method / getter / setter");{let s=r.getInitializers();s=r.value.getInitializers().concat(s);const a=InitializerFactory.createFieldInitializer(t,i,r),o=InitializerFactory.chainInitializerAttributes(a,s);let c=r.getInterceptors();c=r.value.getInterceptors().concat(c);const p=InterceptorChainFactory.chainInterceptorAttributes(o,c);if(p instanceof InitializerInvocation||p instanceof InterceptorInvocation){if(e.has(i))throw new Error(`Class: ${t.prototype.constructor.name}; Property: ${r.targetKey.toString()}; `+"Duplicate initializer");e.add(i),n||(n=new Map),n.set(i,[a,p])}}}return n}}class ConstructCompiler{constructor(t,e,r,n){this._newTarget=t,this._target=e,this._design=r,this._params=n}get target(){return this._target}get agent(){}get design(){return this._design}get compiler(){const t=g(AgentCompiler);return Reflect.defineProperty(this,"compiler",{value:t}),t}get compiledParameters(){const t=this.compiler.compileParameters(this._target,c(this._target));return Reflect.defineProperty(this,"compiledParameters",{value:t}),t}get compiledTarget(){const t=this.compiler.compile(this._newTarget,this._params);return Reflect.defineProperty(this,"compiledTarget",{value:t}),t}}class InterceptedConstructInvocation extends ConstructCompiler{constructor(t,e,r,n,i){super(t,r,i,n),this._args=e}invoke(t){let e=Array.prototype.slice.call(t,0);for(const[r,[,n]]of this.compiledParameters.entries())e[r]=n.invoke([t[r],r,e]);return h.set(this._args,e),Reflect.construct(this._target,e,this.compiledTarget)}}class DirectConstructInvocation extends ConstructCompiler{constructor(t,e,r,n,i){super(t,r,i,n),this._args=e}invoke(t){return Array.isArray(t)&&h.set(this._args,t),Reflect.construct(this._target,t,this.compiledTarget)}}class InterceptorConstructorFactory{static createConstructor(t,e,r,n){const i=c(r);let s;s=i.hasParameters()?new InterceptedConstructInvocation(t,e,r,n,i):new DirectConstructInvocation(t,e,r,n,i);const a=i.getInterceptors();return InterceptorChainFactory.chainInterceptorAttributes(s,a)}}const d="Agent";class LazyClassInitializer{constructor(){this.target=function(t){return h.has(t)?h.get(t):t};const t=new WeakMap;Reflect.set(this.target,"construct",function(e,r,n,i){let s=t.get(e);return s||(s=InterceptorConstructorFactory.createConstructor(e,r,n,i),t.set(e,s)),s.invoke(r)})}initialize(t,e){const r=t.target.name||d,n=c(t.target),i=`class ${r}$ extends ${r}{\n`+`  constructor(){return Reflect.construct(${r}$,arguments,${r},()=>Reflect(arguments))}\n`+"}";return t.invoke([r,i,this.target,n])}}class AgentAttribute{beforeDecorate(t){return!0}get initializer(){return g(LazyClassInitializer)}}let f=function(){return function(){}};Reflect.metadata&&!Reflect.metadata.af&&(f=Reflect.metadata),Reflect.metadata=function(t,e){return function(t,e,r){e?c(t).property(e,r).addMetadata(this.key,this.value):c(t).addMetadata(this.key,this.value),this.polyfill(t,e,r)}.bind({key:t,value:e,polyfill:f.apply(this,[t,e])})},Reflect.metadata.af=!0,exports.decorate=function(e,r){return(n,i,s)=>{let a=typeof s;if(null==i){if("number"===a){if(exports.Target.ConstructorParameter!==(r&exports.Target.ConstructorParameter))throw new TypeError(`${e.constructor.name} is not allow decorate on constructor parameters`)}else if(exports.Target.Constructor!==(r&exports.Target.Constructor))throw new TypeError(`${e.constructor.name} is not allow decorate on class`)}else if("number"===a){if(exports.Target.MethodParameter!==(r&exports.Target.MethodParameter))throw new TypeError(`${e.constructor.name} is not allow decorate on method parameters`)}else if(s){if(s.value)if("function"==typeof s.value){if(exports.Target.Method!==(r&exports.Target.Method))throw new TypeError(`${e.constructor.name} is not allow decorate on method`)}else if(exports.Target.Field!==(r&exports.Target.Field))throw new TypeError(`${e.constructor.name} is not allow decorate on field`);if(s.get&&exports.Target.Getter!==(r&exports.Target.Getter))throw new TypeError(`${e.constructor.name} is not allow decorate on getter`);if(s.set&&exports.Target.Setter!==(r&exports.Target.Setter))throw new TypeError(`${e.constructor.name} is not allow decorate on setter`)}else if(exports.Target.Field!==(r&exports.Target.Field))throw new TypeError(`${e.constructor.name} is not allow decorate on field`);t(e,n,i)&&(null==i?"number"===a?t(e,n,i)&&c(n).parameter(s).addAttribute(e):c(n).addAttribute(e):"number"===a?c(n).property(i).value.parameter(s).addAttribute(e):s?c(n).property(i,s).value.addAttribute(e):c(n).property(i).value.addAttribute(e))}},exports.decorateAgent=l,exports.decorateParameter=function(e){return(r,n,i)=>{t(e,r,n,i)&&(null==n?c(r).parameter(i).addAttribute(e):c(r).property(n).value.parameter(i).addAttribute(e))}},exports.decorateClass=function(e){return r=>{t(e,r)&&c(r).addAttribute(e)}},exports.decorateClassField=function(e){return(r,n,i)=>{if(i)throw new TypeError(`${Reflect.getPrototypeOf(e).constructor.name} can only decorate on class field property`);t(e,r,n)&&c(r).property(n).value.addAttribute(e)}},exports.decorateClassMember=function(e){return(r,n,i)=>{t(e,r,n,i)&&c(r).property(n,i).addAttribute(e)}},exports.decorateClassMethod=function(e){return(r,n,i)=>{t(e,r,n,i)&&c(r).property(n,i).value.addAttribute(e)}},exports.Member=Member,exports.Type=Type,exports.Property=Property,exports.Method=Method,exports.Parameter=Parameter,exports.PropertyFilters=PropertyFilters,exports.AgentAttribute=AgentAttribute,exports.Agent=function(e,r){return r||(r=g(AgentAttribute)),t(r,e)?u(e,r):e},exports.agent=function(t){return l(g(AgentAttribute),t)},exports.Reflector=c,exports.IsAgent=o,exports.GetType=function(t){return s.get(t)};
//# sourceMappingURL=index.js.map
